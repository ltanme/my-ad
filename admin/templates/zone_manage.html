{% extends "base.html" %}

{% block title %}{{ zone_name }} - 区域管理{% endblock %}

{% block extra_css %}
<style>
    .playlist-card {
        transition: all 0.3s;
    }

    .playlist-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .playlist-card.active {
        border: 2px solid #0d6efd;
    }

    .item-list {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">← 返回</a>
            <h2 class="d-inline ms-3">{{ zone_name }}</h2>
            <span class="badge bg-secondary ms-2">{{ zone_code }}</span>
        </div>
        <button class="btn btn-primary" onclick="showCreatePlaylistModal()">
            <i class="bi bi-plus-lg"></i> 新建播放列表
        </button>
    </div>

    <div class="row g-3">
        {% if playlists %}
        {% for playlist in playlists %}
        <div class="col-md-6">
            <div class="card playlist-card {% if playlist.is_active %}active{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ playlist.name }}</strong>
                        {% if playlist.is_active %}
                        <span class="badge bg-success ms-2">活跃</span>
                        {% endif %}
                    </div>
                    <div class="btn-group btn-group-sm">
                        {% if not playlist.is_active %}
                        <button class="btn btn-outline-success"
                            onclick="activatePlaylist({{ playlist.id }})">激活</button>
                        {% else %}
                        <button class="btn btn-outline-secondary"
                            onclick="reloadPlaylist({{ playlist.id }})">刷新</button>
                        {% endif %}
                        <button class="btn btn-outline-primary" onclick="manageItems({{ playlist.id }})">管理内容</button>
                        <button class="btn btn-outline-danger" onclick="deletePlaylist({{ playlist.id }})">删除</button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="mb-1"><small class="text-muted">循环模式: {{ playlist.loop_mode }}</small></p>
                    <p class="mb-0"><small class="text-muted">创建时间: {{ playlist.created_at }}</small></p>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="alert alert-info">
                该区域还没有播放列表，点击右上角按钮创建一个。
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- 创建播放列表模态框 -->
<div class="modal fade" id="createPlaylistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新建播放列表</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPlaylistForm">
                    <div class="mb-3">
                        <label class="form-label">列表名称</label>
                        <input type="text" class="form-control" id="playlistName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">循环模式</label>
                        <select class="form-select" id="loopMode">
                            <option value="loop">循环播放</option>
                            <option value="once">播放一次</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createPlaylist()">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 管理内容模态框 -->
<div class="modal fade" id="manageItemsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">管理播放内容</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-sm btn-primary" onclick="showAddTextModal()">添加文字</button>
                    <button class="btn btn-sm btn-warning" onclick="showAddCountdownModal()">添加倒计时</button>
                    <button class="btn btn-sm btn-success" onclick="showUploadModal()">上传图片/视频</button>
                </div>
                <div class="item-list" id="itemList">
                    <p class="text-muted">加载中...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加文字模态框 -->
<div class="modal fade" id="addTextModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加文字内容</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTextForm">
                    <div class="mb-3">
                        <label class="form-label">文字内容</label>
                        <textarea class="form-control" id="textContent" rows="3" required></textarea>
                    </div>
                        <div class="mb-3">
                            <label class="form-label">显示时长(毫秒)</label>
                            <input type="number" class="form-control" id="displayMs" value="5000">
                        </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addTextItem()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 上传文件模态框 -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">上传图片/视频</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">选择文件</label>
                        <input type="file" class="form-control" id="fileInput" accept="image/*,video/*,.heic,.heif" multiple required>
                        <div class="form-text">支持格式: PNG, JPG, GIF, HEIC, MP4, AVI, MOV, MKV；单次最多选择 9 个文件</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">显示时长(毫秒) - 仅图片</label>
                        <input type="number" class="form-control" id="uploadDisplayMs" value="5000">
                        <div class="form-text">视频将自动使用视频时长</div>
                    </div>
                    <div id="uploadProgress" class="progress d-none mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            style="width: 0%"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="uploadFile()" id="uploadBtn">上传</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加倒计时模态框 -->
<div class="modal fade" id="addCountdownModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加倒计时内容</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCountdownForm">
                    <div class="mb-3">
                        <label class="form-label">倒计时标题</label>
                        <input type="text" class="form-control" id="countdownTitle" placeholder="例如：开幕倒计时" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">目标日期</label>
                        <input type="date" class="form-control" id="countdownDate" required>
                        <div class="form-text">格式：YYYY-MM-DD，必须大于今天</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">显示时长(毫秒)</label>
                        <input type="number" class="form-control" id="countdownDisplayMs" value="5000">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="addCountdownItem()">添加</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const zoneCode = '{{ zone_code }}';
    let currentPlaylistId = null;

    function showCreatePlaylistModal() {
        new bootstrap.Modal(document.getElementById('createPlaylistModal')).show();
    }

    function createPlaylist() {
        const name = $('#playlistName').val();
        const loopMode = $('#loopMode').val();

        $.ajax({
            url: '/api/playlist/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                zone_code: zoneCode,
                name: name,
                loop_mode: loopMode
            }),
            success: function (res) {
                if (res.success) {
                    location.reload();
                } else {
                    alert('创建失败: ' + res.error);
                }
            }
        });
    }

    function activatePlaylist(playlistId) {
        if (!confirm('确定要激活这个播放列表吗？')) return;

        $.ajax({
            url: `/api/playlist/${playlistId}/activate`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ zone_code: zoneCode }),
            success: function (res) {
                if (res.success) {
                    location.reload();
                } else {
                    alert('激活失败: ' + res.error);
                }
            }
        });
    }

    function reloadPlaylist(playlistId) {
        $.ajax({
            url: `/api/playlist/${playlistId}/activate`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ zone_code: zoneCode }),
            success: function (res) {
                if (res.success) {
                    alert('已通知刷新');
                } else {
                    alert('刷新失败: ' + res.error);
                }
            }
        });
    }

    function deletePlaylist(playlistId) {
        if (!confirm('确定要删除这个播放列表吗？此操作不可恢复！')) return;

        $.ajax({
            url: `/api/playlist/${playlistId}/delete`,
            method: 'POST',
            success: function (res) {
                if (res.success) {
                    location.reload();
                } else {
                    alert('删除失败: ' + res.error);
                }
            }
        });
    }

    function setFirst(itemId) {
        $.ajax({
            url: `/api/item/${itemId}/first`,
            method: 'POST',
            success: function (res) {
                if (res.success) {
                    loadItems(currentPlaylistId);
                } else {
                    alert('置顶失败: ' + res.error);
                }
            }
        });
    }

    function saveAssetTitle(assetId, title) {
        $.ajax({
            url: `/api/asset/${assetId}/title`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ title: title }),
            success: function (res) {
                if (!res.success) {
                    alert('保存标题失败: ' + res.error);
                }
            }
        });
    }

    function manageItems(playlistId) {
        currentPlaylistId = playlistId;
        loadItems(playlistId);
        new bootstrap.Modal(document.getElementById('manageItemsModal')).show();
    }

    function loadItems(playlistId) {
        return $.ajax({
            url: `/api/playlist/${playlistId}/items`,
            method: 'GET',
            success: function (res) {
                if (res.success) {
                    displayItems(res.items);
                }
            }
        });
    }

    function displayItems(items) {
        const html = items.length > 0 ? items.map((item, idx) => `
        <div class="card mb-2">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong>#${idx + 1}</strong>
                            <span class="badge bg-secondary ms-2">ID: ${item.id}</span>
                            ${item.asset_id ? `<span class="badge bg-primary ms-1">资源ID: ${item.asset_id}</span>` : ''}
                            ${item.kind ? `<span class="badge bg-info ms-1">${item.kind}</span>` : ''}
                            ${item.countdown_target ? `<span class="badge bg-warning text-dark ms-1">倒计时</span>` : ''}
                        </div>
                        ${item.countdown_target ? `
                            <div class="mb-1">
                                <strong>倒计时:</strong> <span class="text-break">${item.text_inline || '(无标题)'}</span>
                                <span class="ms-2 text-muted">目标日期: ${item.countdown_target}</span>
                            </div>
                        ` : item.text_inline ? `
                            <div class="mb-1">
                                <strong>文字内容:</strong> <span class="text-break">${item.text_inline}</span>
                            </div>
                        ` : ''}
                        ${item.uri ? `
                            <div class="mb-1">
                                <strong>资源路径:</strong> 
                                <code class="text-break small">${item.uri}</code>
                            </div>
                        ` : ''}
                        ${item.asset_id && item.original_name ? `
                            <div class="mb-1 d-flex align-items-center">
                                <strong class="me-2">标题:</strong>
                                <input class="form-control form-control-sm" style="max-width: 320px;"
                                       value="${item.original_name}"
                                       onblur="saveAssetTitle(${item.asset_id}, this.value)"
                                       onclick="this.select()">
                            </div>
                        ` : ''}
                        <small class="text-muted d-block">
                            <i class="bi bi-clock"></i> 添加时间: ${item.created_at || '未知'}
                            ${item.display_ms ? ` | <i class="bi bi-hourglass"></i> 显示时长: ${item.display_ms}ms` : ''}
                            ${item.play_order ? ` | 播放顺序: ${item.play_order}` : ''}
                        </small>
                    </div>
                    <div class="btn-group btn-group-sm ms-2">
                        <button class="btn btn-outline-secondary" title="设为首个播放" onclick="setFirst(${item.id})">
                            <i class="bi bi-pin-angle"></i>
                        </button>
                        <button class="btn btn-outline-danger" title="删除" onclick="deleteItem(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('') : '<p class="text-muted">暂无内容</p>';

        $('#itemList').html(html);
    }

    function showAddTextModal() {
        new bootstrap.Modal(document.getElementById('addTextModal')).show();
    }

    function addTextItem() {
        const text = $('#textContent').val();
        const displayMs = $('#displayMs').val();

        $.ajax({
            url: '/api/item/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                playlist_id: currentPlaylistId,
                type: 'text',
                text: text,
                display_ms: parseInt(displayMs)
            }),
            success: function (res) {
                if (res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addTextModal')).hide();
                    loadItems(currentPlaylistId);
                    $('#textContent').val('');
                    $('#displayMs').val('5000');
                } else {
                    alert('添加失败: ' + res.error);
                }
            }
        });
    }

    function showAddCountdownModal() {
        const today = new Date().toISOString().split('T')[0];
        $('#countdownDate').attr('min', today);
        $('#countdownDate').val('');
        $('#countdownTitle').val('');
        $('#countdownDisplayMs').val('5000');
        new bootstrap.Modal(document.getElementById('addCountdownModal')).show();
    }

    function addCountdownItem() {
        const title = $('#countdownTitle').val();
        const dateStr = $('#countdownDate').val();
        const displayMs = $('#countdownDisplayMs').val();

        if (!dateStr) {
            alert('请选择目标日期');
            return;
        }

        $.ajax({
            url: '/api/item/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                playlist_id: currentPlaylistId,
                type: 'countdown',
                title: title,
                target_date: dateStr,
                display_ms: parseInt(displayMs)
            }),
            success: function (res) {
                if (res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addCountdownModal')).hide();
                    loadItems(currentPlaylistId);
                    $('#countdownTitle').val('');
                    $('#countdownDate').val('');
                } else {
                    alert('添加失败: ' + res.error);
                }
            }
        });
    }

    function deleteItem(itemId) {
        if (!confirm('确定要删除这个项目吗？')) return;

        $.ajax({
            url: `/api/item/${itemId}/delete`,
            method: 'POST',
            success: function (res) {
                if (res.success) {
                    loadItems(currentPlaylistId);
                } else {
                    alert('删除失败: ' + res.error);
                }
            }
        });
    }

    function showUploadModal() {
        if (!currentPlaylistId) {
            alert('请先选择一个播放列表');
            return;
        }
        new bootstrap.Modal(document.getElementById('uploadModal')).show();
    }

    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const files = Array.from(fileInput.files || []);

        if (!files.length) {
            alert('请选择文件');
            return;
        }
        if (files.length > 9) {
            alert('单次最多选择 9 个文件');
            return;
        }

        const displayMs = $('#uploadDisplayMs').val();
        $('#uploadProgress').removeClass('d-none');
        $('#uploadBtn').prop('disabled', true).text('上传中...');

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('playlist_id', currentPlaylistId);
                formData.append('display_ms', displayMs);

                await $.ajax({
                    url: '/api/upload',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        if (!res.success) {
                            throw new Error(res.error || '上传失败');
                        }
                    }
                });

                const percent = Math.round(((i + 1) / files.length) * 100);
                $('#uploadProgress .progress-bar').css('width', percent + '%');
            }

            alert('上传成功！');
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            await loadItems(currentPlaylistId);
        } catch (err) {
            alert(err.message || '上传失败');
        } finally {
            fileInput.value = '';
            $('#uploadProgress').addClass('d-none');
            $('#uploadProgress .progress-bar').css('width', '0%');
            $('#uploadBtn').prop('disabled', false).text('上传');
        }
    }
</script>
{% endblock %}
